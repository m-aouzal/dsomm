{% extends "base.html" %} {% block content %}
<h1>Résolution de Conflits (en mode Debug)</h1>

<form
  method="POST"
  action="{{ url_for('conflict_resolution.resolve_conflict') }}"
>
  <p>
    Cochez un ou plusieurs outils par activité, ou "none" pour la laisser non
    implémentée. S'il y a plusieurs outils en "temporary", c'est qu'il y a
    conflit potentiel.
  </p>
  <hr />
  <ol>
    {% for act_item in activities %} {% if act_item.status == 'temporary' %}
    <li>
      <strong>{{ act_item.activity }}</strong> ({{ act_item.status }})<br />
      {% if act_item.description %}
      <em>{{ act_item.description }}</em><br />
      {% endif %}
      <div class="tool-selection-container">
        <div class="form-check mb-3">
          <input
            type="checkbox"
            class="form-check-input"
            name="choice_{{ act_item.activity }}"
            id="none_{{ act_item.activity }}"
            value="none"
            onclick="handleNoneSelection('{{ act_item.activity }}')"
          />
          <label class="form-check-label" for="none_{{ act_item.activity }}">
            <strong>None (Mark as unimplemented)</strong>
          </label>
        </div>

        <div class="standard-tools mb-3">
          <h5>Standard Tools:</h5>
          {% for t_name in act_item.tools %}
          {% if t_name not in act_item.custom %}
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input tool-checkbox"
              name="choice_{{ act_item.activity }}"
              id="{{ t_name }}_{{ act_item.activity }}"
              value="{{ t_name }}"
              onclick="handleToolSelection('{{ act_item.activity }}')"
              {% if act_item.tools[t_name] == 'checked' %} checked {% endif %}
            />
            <label class="form-check-label" for="{{ t_name }}_{{ act_item.activity }}">
              {{ t_name }}
            </label>
          </div>
          {% endif %}
          {% endfor %}
        </div>

        <div class="custom-tools mb-3">
          <h5>Custom Tools:</h5>
          {% for c_tool in act_item.custom %}
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input tool-checkbox"
              name="choice_{{ act_item.activity }}"
              id="{{ c_tool }}_{{ act_item.activity }}"
              value="{{ c_tool }}"
              onclick="handleToolSelection('{{ act_item.activity }}')"
              {% if c_tool in act_item.tools and act_item.tools[c_tool] == 'checked' %} checked {% endif %}
            />
            <label class="form-check-label" for="{{ c_tool }}_{{ act_item.activity }}">
              {{ c_tool }} (Custom)
            </label>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="mt-3">
        <label>Ajouter un Outil Custom:</label>
        <div class="input-group mb-2">
          <input
            type="text"
            id="new_custom_{{ act_item.activity }}"
            name="new_custom_{{ act_item.activity }}"
            class="form-control"
            placeholder="Enter custom tool"
          />
          <button
            type="button"
            class="btn btn-success"
            onclick="addCustomTool('{{ act_item.activity }}')"
          >
            Add
          </button>
        </div>
      </div>
      <div class="mt-3" id="customToolContainer_{{ act_item.activity }}">
        <h4>Outils Custom Ajoutés:</h4>
      </div>
      <hr />
    </li>
    {% endif %} {% endfor %}
  </ol>

  <button type="submit" class="btn btn-primary">Résoudre</button>
</form>

<script>
  function handleNoneSelection(activityName) {
    const boxes = document.getElementsByName(`choice_${activityName}`);
    const noneBox = document.getElementById(`none_${activityName}`);
    for (let cb of boxes) {
      cb.checked = false;
    }
    noneBox.checked = true;
  }

  function uncheckNone(activityName) {
    const noneBox = document.getElementById(`none_${activityName}`);
    if (noneBox) {
      noneBox.checked = false;
    }
  }

  function addCustomTool(activityName) {
    const inputField = document.getElementById(`new_custom_${activityName}`);
    const customToolName = inputField.value.trim();

    if (!customToolName) {
      alert("Veuillez entrer un nom d'outil.");
      return;
    }

    const container = document.getElementById(
      `customToolContainer_${activityName}`
    );

    // Create the checkbox input element
    const newCheckbox = document.createElement("input");
    newCheckbox.type = "checkbox";
    newCheckbox.className = "form-check-input";
    newCheckbox.name = `choice_${activityName}`;
    newCheckbox.id = `${customToolName}_${activityName}`;
    newCheckbox.value = customToolName;
    newCheckbox.checked = true;
    newCheckbox.onclick = () => uncheckNone(activityName);

    // Create the label for the checkbox
    const newLabel = document.createElement("label");
    newLabel.className = "form-check-label";
    newLabel.htmlFor = `${customToolName}_${activityName}`;
    newLabel.textContent = `${customToolName} (Custom)`;

    // Create the div to hold the checkbox and label
    const newDiv = document.createElement("div");
    newDiv.className = "form-check";
    newDiv.appendChild(newCheckbox);
    newDiv.appendChild(newLabel);

    // Create a remove button
    const removeButton = document.createElement("button");
    removeButton.type = "button";
    removeButton.className = "btn btn-danger btn-sm ml-2";
    removeButton.textContent = "Supprimer";
    removeButton.onclick = () => removeCustomToolItem(newDiv);

    // Create a container for the new tool item
    const toolItem = document.createElement("div");
    toolItem.className = "input-group mb-2 custom-tool-item";
    toolItem.appendChild(newDiv);
    toolItem.appendChild(removeButton);

    // Add the new tool item to the container
    container.appendChild(toolItem);

    // Clear the input field
    inputField.value = "";
  }

  function removeCustomToolItem(item) {
    // Remove the entire item (checkbox, label, and button)
    item.remove();
  }
</script>
{% endblock %}
