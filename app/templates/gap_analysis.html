{% extends "base.html" %} {% block content %}

<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/gap_analysis.css', v=1) }}"
/>

<div class="container">
  <h1>Gap Analysis</h1>

  <div class="activity-container">
    <h2>{{ activity.activity }}</h2>
    <p class="description">{{ activity.description }}</p>

    {% if activity_details %}
    <button
      class="btn btn-info mb-3"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#activityDetails"
    >
      See Full Details
    </button>
    <div class="collapse mb-4" id="activityDetails">
      <div class="card card-body">
        <p>
          <strong>Full Description:</strong> {{ activity_details.description }}
        </p>
      </div>
    </div>
    {% endif %}

    <form
      method="POST"
      action="{{ url_for('gap_analysis.analyze') }}"
      id="gapForm"
    >
      <input type="hidden" name="activity" value="{{ activity.activity }}" />

      <!-- None option -->
      <div class="tool-selection-container">
        <div class="form-check">
          <input
            type="checkbox"
            class="form-check-input"
            id="none"
            name="tools"
            value="none"
            onclick="handleNoneSelection()"
          />
          <label class="form-check-label" for="none">
            <strong>None (Mark as not implemented)</strong>
          </label>
        </div>

        <!-- Standard tools -->
        {% if relevant_tools.standard %}
        <div class="standard-tools">
          <h5>Standard tools:</h5>
          {% for tool in relevant_tools.standard %}
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input tool-checkbox"
              id="{{ tool }}"
              name="tools"
              value="{{ tool }}"
              onclick="uncheckNone(); checkFormCompletion();"
            />
            <label class="form-check-label" for="{{ tool }}">{{ tool }}</label>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Custom tools -->
        {% if relevant_tools.custom %}
        <div class="custom-tools">
          <h5>Custom tools:</h5>
          {% for tool in relevant_tools.custom %}
          <div class="form-check">
            <input
              type="checkbox"
              class="form-check-input tool-checkbox"
              id="{{ tool }}"
              name="custom_tools"
              value="{{ tool }}"
              onclick="uncheckNone(); checkFormCompletion();"
            />
            <label class="form-check-label" for="{{ tool }}"
              >{{ tool }} (Custom)</label
            >
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Add custom tool -->
      <div class="custom-tool-input">
        <h2>Add Custom Tools:</h2>
        <div class="input-group">
          <input
            type="text"
            id="customToolInput"
            class="form-control"
            placeholder="Custom tool name"
          />
          <button
            type="button"
            class="btn btn-success"
            onclick="addCustomTool()"
          >
            ADD
          </button>
        </div>
      </div>

      <div id="customToolContainer">
        <!-- Custom tools will be added here dynamically -->
      </div>

      <button type="submit" class="btn" id="submitBtn" disabled>
        Continue
      </button>
    </form>
  </div>
</div>

<script>
  function handleNoneSelection() {
    const noneCheckbox = document.getElementById("none");
    const toolCheckboxes = document.querySelectorAll(".tool-checkbox");

    if (noneCheckbox.checked) {
      toolCheckboxes.forEach((cb) => {
        cb.checked = false;
      });
    }
  }

  function uncheckNone() {
    document.getElementById("none").checked = false;
  }

  function addCustomTool() {
    const input = document.getElementById("customToolInput");
    const toolName = input.value.trim();

    if (!toolName) {
      alert("Please enter a tool name.");
      return;
    }

    const container = document.getElementById("customToolContainer");
    const toolDiv = document.createElement("div");
    toolDiv.className = "custom-tool-item";

    toolDiv.innerHTML = `
      <div class="form-check">
        <input type="checkbox" 
               class="form-check-input tool-checkbox" 
               id="${toolName}" 
               name="custom_tools" 
               value="${toolName}"
               checked
               onclick="uncheckNone(); checkFormCompletion();">
        <label class="form-check-label" for="${toolName}">
          ${toolName} (Custom)
        </label>
        <button type="button" class="btn btn-success" onclick="removeCustomTool(this)">
          REMOVE
        </button>
      </div>
    `;

    container.appendChild(toolDiv);
    input.value = "";
    checkFormCompletion();
  }

  function removeCustomTool(button) {
    button.closest(".custom-tool-item").remove();
  }

  function checkFormCompletion() {
    const noneChecked = document.getElementById("none").checked;
    const standardTools = document.querySelectorAll(
      'input[name="tools"]:checked'
    ).length;
    const customTools = document.querySelectorAll(
      'input[name="custom_tools"]:checked'
    ).length;

    document.getElementById("submitBtn").disabled = !(
      noneChecked ||
      standardTools > 0 ||
      customTools > 0
    );
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", function () {
    handleNoneSelection();
    checkFormCompletion();
  });
</script>
{% endblock %}
